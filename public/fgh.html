<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Community</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 600px; margin: 0 auto; }
        .card { 
            background: rgba(255, 255, 255, 0.95);
            padding: 25px; 
            margin: 15px 0; 
            border-radius: 20px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        button { 
            background: linear-gradient(135deg, #0088cc 0%, #006699 100%);
            color: white; 
            border: none; 
            padding: 15px 25px; 
            margin: 10px 5px; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        button.admin { 
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        .hidden { display: none; }
        .post { 
            border: 2px solid #f1f3f4; 
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 15px; 
            background: white;
            transition: all 0.3s ease;
        }
        .post:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .user-info { 
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 20px; 
            border-radius: 15px; 
            margin: 15px 0; 
        }
        h1 { 
            color: #333; 
            text-align: center; 
            margin-bottom: 20px;
            font-size: 2.5em;
        }
        h2 { color: #0088cc; margin-bottom: 15px; }
        input, textarea { 
            width: 100%; 
            padding: 15px; 
            margin: 10px 0; 
            border: 2px solid #e9ecef; 
            border-radius: 10px; 
            font-size: 16px;
            transition: all 0.3s ease;
        }
        input:focus, textarea:focus { 
            border-color: #0088cc;
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 136, 204, 0.1);
        }
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: 600;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <!-- –°—Ç–∞—Ç—É—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è -->
        <div class="card">
            <h1>ü§ñ Telegram Community</h1>
            <div id="status" class="status">üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º...</div>
        </div>

        <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
        <div id="authSection" class="card">
            <h2>üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
            <p style="margin-bottom: 15px; color: #666;">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏:</p>
            <button onclick="loginDemoUser()">üë§ –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</button>
            <button onclick="loginDemoAdmin()" class="admin">üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</button>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div id="userSection" class="card hidden">
            <div class="user-info">
                <h2>üë§ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                <div id="userInfo"></div>
                <button onclick="logout()">üö™ –í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</button>
            </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
        <div id="adminSection" class="card hidden">
            <h2>‚öôÔ∏è –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
            <p style="margin-bottom: 15px; color: #666;">–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤–æ—Å—Ç–∏ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
            <input type="text" id="postTitle" placeholder="üìù –í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ—Å—Ç–∞">
            <textarea id="postContent" placeholder="üìÑ –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞" rows="4"></textarea>
            <button onclick="createPost()">üì§ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–æ–≤–æ—Å—Ç—å</button>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–æ–≤ -->
        <div class="card">
            <h2>üì∞ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞</h2>
            <div id="postsContainer">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π...</div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let currentUser = null;
        const ADMIN_ID = 8036875641;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º
        async function checkServerStatus() {
            try {
                const response = await fetch(API_BASE + '/api/health');
                if (!response.ok) throw new Error('Server error');
                
                const data = await response.json();
                document.getElementById('status').className = 'status success';
                document.getElementById('status').innerHTML = `‚úÖ ${data.message}`;
                return true;
            } catch (error) {
                document.getElementById('status').className = 'status error';
                document.getElementById('status').innerHTML = '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
                console.error('Server connection failed:', error);
                return false;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤
        async function loadPosts() {
            try {
                const response = await fetch(API_BASE + '/api/posts');
                if (!response.ok) throw new Error('Failed to fetch posts');
                
                const posts = await response.json();
                displayPosts(posts);
            } catch (error) {
                console.error('Error loading posts:', error);
                document.getElementById('postsContainer').innerHTML = 
                    '<div class="post" style="color: #dc3545;">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤–æ—Å—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.</div>';
            }
        }

        function displayPosts(posts) {
            const container = document.getElementById('postsContainer');
            
            if (!posts || posts.length === 0) {
                container.innerHTML = '<div class="post">üìù –ü–æ–∫–∞ –Ω–µ—Ç –Ω–æ–≤–æ—Å—Ç–µ–π. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º, –∫—Ç–æ –æ–ø—É–±–ª–∏–∫—É–µ—Ç —á—Ç–æ-—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ!</div>';
                return;
            }

            container.innerHTML = posts.map(post => `
                <div class="post">
                    <h3 style="color: #0088cc; margin-bottom: 10px;">${post.title}</h3>
                    <p style="line-height: 1.6; margin-bottom: 10px; font-size: 16px;">${post.content}</p>
                    <small style="color: #666;">üìÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: ${new Date(post.created_at).toLocaleDateString('ru-RU', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })}</small>
                    ${currentUser && currentUser.id === ADMIN_ID ? 
                        `<br><br><button onclick="deletePost(${post.id})" class="admin">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —ç—Ç—É –Ω–æ–≤–æ—Å—Ç—å</button>` : ''}
                </div>
            `).join('');
        }

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        async function loginUser(userData) {
            try {
                const response = await fetch(API_BASE + '/api/users', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                if (!response.ok) throw new Error('Login failed');
                
                currentUser = await response.json();
                showUserInterface();
                await loadPosts();
                
                // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —É—Å–ø–µ—à–Ω–æ–º –≤—Ö–æ–¥–µ
                setTimeout(() => {
                    alert(`‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${currentUser.first_name}!`);
                }, 100);
                
            } catch (error) {
                console.error('Login error:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤ —Å–∏—Å—Ç–µ–º—É. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            }
        }

        // –î–µ–º–æ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        function loginDemoUser() {
            loginUser({
                telegram_id: Math.floor(Math.random() * 1000000000),
                first_name: '–î–µ–º–æ',
                last_name: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                username: 'demo_user'
            });
        }

        // –î–µ–º–æ-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
        function loginDemoAdmin() {
            loginUser({
                telegram_id: ADMIN_ID,
                first_name: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
                last_name: '–°–∏—Å—Ç–µ–º—ã',
                username: 'admin'
            });
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function showUserInterface() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('userSection').classList.remove('hidden');
            
            const isAdmin = currentUser.id === ADMIN_ID;
            document.getElementById('userInfo').innerHTML = `
                <p><strong>üÜî ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</strong> ${currentUser.id}</p>
                <p><strong>üë§ –ò–º—è:</strong> ${currentUser.first_name} ${currentUser.last_name}</p>
                <p><strong>üéØ –†–æ–ª—å:</strong> ${isAdmin ? '<span style="color: #dc3545; font-weight: bold;">üëë –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†</span>' : 'üë§ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨'}</p>
                <p><strong>üîó –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥:</strong> ${currentUser.referral_code}</p>
            `;

            if (isAdmin) {
                document.getElementById('adminSection').classList.remove('hidden');
            }
        }

        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        function logout() {
            currentUser = null;
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('userSection').classList.add('hidden');
            document.getElementById('adminSection').classList.add('hidden');
            loadPosts();
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞
        async function createPost() {
            if (!currentUser || currentUser.id !== ADMIN_ID) {
                alert('‚ùå –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–æ–≤–æ—Å—Ç–∏');
                return;
            }

            const title = document.getElementById('postTitle').value.trim();
            const content = document.getElementById('postContent').value.trim();

            if (!title || !content) {
                alert('‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            try {
                const response = await fetch(API_BASE + '/api/posts', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title,
                        content,
                        author_id: currentUser.id
                    })
                });

                if (!response.ok) throw new Error('Failed to create post');

                // –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
                document.getElementById('postTitle').value = '';
                document.getElementById('postContent').value = '';
                
                // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–æ–≤
                await loadPosts();
                
                // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                alert('‚úÖ –ù–æ–≤–æ—Å—Ç—å —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞!');
                
            } catch (error) {
                console.error('Error creating post:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –Ω–æ–≤–æ—Å—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞
        async function deletePost(postId) {
            if (!currentUser || currentUser.id !== ADMIN_ID) return;

            if (!confirm('‚ùì –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –Ω–æ–≤–æ—Å—Ç—å? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                return;
            }

            try {
                const response = await fetch(API_BASE + `/api/posts?id=${postId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete post');

                await loadPosts();
                alert('‚úÖ –ù–æ–≤–æ—Å—Ç—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!');
                
            } catch (error) {
                console.error('Error deleting post:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ—Å—Ç–∏.');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', async () => {
            // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º
            const isConnected = await checkServerStatus();
            
            if (isConnected) {
                // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ—Å—Ç—ã
                await loadPosts();
                
                // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Telegram Web App
                if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
                    const tg = Telegram.WebApp;
                    tg.expand();
                    
                    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –≤ Telegram
                    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                        const tgUser = tg.initDataUnsafe.user;
                        loginUser(tgUser);
                    }
                }
            }
        });

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
        window.loginDemoUser = loginDemoUser;
        window.loginDemoAdmin = loginDemoAdmin;
        window.logout = logout;
        window.createPost = createPost;
        window.deletePost = deletePost;
    </script>
</body>
</html>