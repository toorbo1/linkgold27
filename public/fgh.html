<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Community</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: rgba(255,255,255,0.95); padding: 25px; margin: 15px 0; border-radius: 15px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
        button { background: #0088cc; color: white; border: none; padding: 12px 24px; margin: 8px; border-radius: 8px; cursor: pointer; font-size: 16px; }
        button:hover { background: #006699; }
        button.admin { background: #dc3545; }
        button.admin:hover { background: #c82333; }
        input, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
        .hidden { display: none; }
        .post { border: 2px solid #e9ecef; padding: 20px; margin: 15px 0; border-radius: 10px; background: white; }
        .user-info { background: #e3f2fd; padding: 15px; border-radius: 10px; margin: 15px 0; }
        h1 { color: #333; text-align: center; margin-bottom: 10px; }
        .status { padding: 10px; border-radius: 5px; margin: 10px 0; text-align: center; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>ü§ñ Telegram Community</h1>
            <div id="connectionStatus" class="status">Checking connection...</div>
            
            <div id="authSection">
                <h3>üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h3>
                <button onclick="login(123456789)">üë§ –í–æ–π—Ç–∏ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</button>
                <button onclick="login(8036875641)" class="admin">üëë –í–æ–π—Ç–∏ –∫–∞–∫ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</button>
            </div>
            
            <div id="userSection" class="hidden">
                <div class="user-info">
                    <h3>üë§ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
                    <div id="userInfo"></div>
                    <button onclick="logout()">üö™ –í—ã–π—Ç–∏</button>
                </div>
            </div>
        </div>

        <div id="adminSection" class="card hidden">
            <h3>‚öôÔ∏è –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
            <input type="text" id="postTitle" placeholder="üìù –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ—Å—Ç–∞">
            <textarea id="postContent" placeholder="üìÑ –¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞" rows="4"></textarea>
            <button onclick="createPost()">üì§ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø–æ—Å—Ç</button>
        </div>

        <div class="card">
            <h3>üì∞ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞</h3>
            <div id="postsContainer">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π...</div>
        </div>
    </div>

    <script>
        let currentUser = null;
        const ADMIN_ID = 8036875641;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        async function checkConnection() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                document.getElementById('connectionStatus').className = 'status success';
                document.getElementById('connectionStatus').innerHTML = 
                    `‚úÖ –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç: ${data.message} (–ü–æ—Ä—Ç: ${data.port})`;
                console.log('Server connection OK:', data);
                return true;
            } catch (error) {
                document.getElementById('connectionStatus').className = 'status error';
                document.getElementById('connectionStatus').innerHTML = 
                    '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
                console.error('Server connection failed:', error);
                return false;
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å—Ç–æ–≤
        async function loadPosts() {
            try {
                const response = await fetch('/api/posts');
                if (!response.ok) throw new Error('HTTP error');
                
                const posts = await response.json();
                displayPosts(posts);
            } catch (error) {
                document.getElementById('postsContainer').innerHTML = 
                    '<div class="post">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π</div>';
            }
        }

        function displayPosts(posts) {
            const container = document.getElementById('postsContainer');
            
            if (!posts || posts.length === 0) {
                container.innerHTML = '<div class="post">üìù –ü–æ–∫–∞ –Ω–µ—Ç –Ω–æ–≤–æ—Å—Ç–µ–π. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>';
                return;
            }

            container.innerHTML = posts.map(post => `
                <div class="post">
                    <h4>${post.title}</h4>
                    <p>${post.content}</p>
                    <small>üìÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ: ${new Date(post.created_at).toLocaleDateString('ru-RU')}</small>
                    ${currentUser && currentUser.id === ADMIN_ID ? 
                        `<br><button onclick="deletePost(${post.id})" class="admin">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>` : ''}
                </div>
            `).join('');
        }

        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        async function login(userId) {
            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        telegram_id: userId,
                        first_name: userId === ADMIN_ID ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                        last_name: '–°–∏—Å—Ç–µ–º—ã',
                        username: userId === ADMIN_ID ? 'admin' : 'user'
                    })
                });

                if (!response.ok) throw new Error('Login failed');
                
                currentUser = await response.json();
                showUserInterface();
                loadPosts();
                
                alert(`‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${currentUser.first_name}`);
                
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');
            }
        }

        function showUserInterface() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('userSection').classList.remove('hidden');
            
            const isAdmin = currentUser.id === ADMIN_ID;
            document.getElementById('userInfo').innerHTML = `
                <p><strong>üÜî ID:</strong> ${currentUser.id}</p>
                <p><strong>üë§ –ò–º—è:</strong> ${currentUser.first_name} ${currentUser.last_name}</p>
                <p><strong>üéØ –†–æ–ª—å:</strong> ${isAdmin ? 'üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</p>
            `;

            if (isAdmin) {
                document.getElementById('adminSection').classList.remove('hidden');
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('userSection').classList.add('hidden');
            document.getElementById('adminSection').classList.add('hidden');
            loadPosts();
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–∞
        async function createPost() {
            if (!currentUser || currentUser.id !== ADMIN_ID) {
                alert('‚ùå –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø–æ—Å—Ç—ã');
                return;
            }

            const title = document.getElementById('postTitle').value.trim();
            const content = document.getElementById('postContent').value.trim();

            if (!title || !content) {
                alert('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            try {
                const response = await fetch('/api/posts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title,
                        content,
                        author_id: currentUser.id
                    })
                });

                if (!response.ok) throw new Error('Failed to create post');

                document.getElementById('postTitle').value = '';
                document.getElementById('postContent').value = '';
                await loadPosts();
                alert('‚úÖ –ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!');
                
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –ø–æ—Å—Ç–∞');
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞
        async function deletePost(postId) {
            if (!currentUser || currentUser.id !== ADMIN_ID) return;

            if (!confirm('‚ùì –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?')) return;

            try {
                const response = await fetch(`/api/posts/${postId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete post');

                await loadPosts();
                alert('‚úÖ –ü–æ—Å—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!');
                
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ—Å—Ç–∞');
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('load', async () => {
            const connected = await checkConnection();
            if (connected) {
                await loadPosts();
            }
        });
    </script>
</body>
</html>